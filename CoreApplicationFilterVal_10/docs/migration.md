# Running migrations using EF Core

The entity classes in code and the actual database are decoupled during development. And therefore migrations are used to incrementally sync the entity classes with the database. EF Core is used for migrations. [Here](https://docs.microsoft.com/en-us/ef/core/managing-schemas/migrations/?tabs=vs) is an overview of migrations using EF Core for more information and [here](https://app.gitbook.com/o/-MhAHQRNbXRJJAmyAX--/s/wlBDkDmB9NnayT8MEoDa/platform-application-templates/the-template-runbooks/custom-logic-apis/clean-architecture-cqrs-api/build-your-domain-layer/add-and-run-migrations) is a link to the Platform team's detailed documentation on how to perform the migrations.
</br>

Before this step, make sure the database is connected. Instructions on configuring the database are given above under the ```Configurations``` section.
</br></br>

## Steps
> **Step 1**:</br>
> There may be multiple environments set up for the project and to prevent accidentally migrating to the wrong environment, explicitly state the environment by running:
> - Visual Studios package manager: ```$env:ASPNETCORE_ENVIRONMENT='<environment e.g. "Local">'```</br>
> - Mac on terminal: ```export ASPNETCORE_ENVIRONMENT='<environment e.g. "Local">'```</br>
> - Windows in cmd: ```setx ASPNETCORE_ENVIRONMENT "<environment e.g. "Local">" /M```</br>
>
> **Step 2**:</br>
> Head over to the ```.Infrastructure``` folder in the codebase in the IDE of choice. This is where the database context: ```ApplicationDbContext.cs``` is stored </br>
>
> **Step 3**:</br>
> Add the migration:\
> _Using **dotnet CLI**_:
> ```shell
> dotnet ef --startup-project <path to .Api folder> migrations add <migration name>
> ```
>> Note: ```--startup-project``` is required because the database context and the actual project live in different folders. <path to .Api folder> refers to the location of the ```.Api``` folder i.e. ```../<projectName>.Api```
>
> _Using **Visual Studio package manager**_:
> ```shell
> Add-Migration <migration name>
> ```
>
> **Step 4**:</br>
> Inspect the migration file  generated by intent inside the ```Migrations``` folder</br>
>
> **Step 5**:</br>
> Run the migration:
> _Using **dotnet CLI**_:
> ```shell
> dotnet ef --startup-project <path to .Api folder> database update
> ```
> _Using **Visual Studio package manager**_:
> ```shell
> Update-Database
> ```
</br>

## Migration Naming Standards
Depending on the type of operation that is being performed on the database, choose between the 4 options below:

> 1. Table operation:\
>\<unix datetime in seconds\>\_tb\_\<insert table description\>\_\<insert operation description\>
> 2. View operation:\
>\<unix datetime in seconds\>\_vw\_\<insert view name\>\_\<insert operation description\>
> 3. Stored procedure operation:\
>\<unix datetime in seconds\>\_sp\_\<insert procedure name\>\_\<insert operation description\>
> 4. Function operation:\
>\<unix datetime in seconds\>\_fn\_\<insert function name\> _\<insert operation description\>

The \<unix_datetime_in_seconds\> is autogenerated by EF Core, therefore, don't include this when specifying the migration name.

An example:

_Using **dotnet CLI**_:
>```shell
> dotnet ef --startup-project ../PetStore.Api migrations add tb_Pets_AddedMoreAttributes
>```
